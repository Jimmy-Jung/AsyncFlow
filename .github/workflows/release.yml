name: Release

on:
  push:
    tags:
      - '*.*.*'

permissions:
  contents: write

jobs:
  # Job 1: 태그 생성 시 최종 테스트 실행 (CI에서 건너뛴 테스트 대체)
  test:
    name: Test Before Release
    runs-on: macos-15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v6
      
      - name: Show Xcode and Swift version
        run: |
          xcodebuild -version
          swift --version
      
      - name: Install Tuist
        run: brew install tuist
      
      - name: Install Dependencies
        run: tuist install
      
      - name: Generate Xcode Project
        run: tuist generate
      
      - name: Test AsyncFlow
        run: tuist test AsyncFlow
      
      - name: Generate Coverage Report
        run: |
          # iOS 빌드의 경우 커버리지 경로가 다름
          echo "Coverage report generation for iOS build"
      
      - name: Upload Coverage
        if: false  # iOS 빌드는 커버리지 업로드 스킵
        uses: codecov/codecov-action@v5
        with:
          files: coverage.lcov
          flags: asyncflow
          fail_ci_if_error: false
  
  release:
    name: Create Release
    runs-on: macos-15
    needs: [test]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      
    - name: Get version from tag
      id: tag_name
      run: |
        echo "current_version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        
    - name: Extract changelog
      id: changelog
      run: |
        version=${{ steps.tag_name.outputs.current_version }}
        changelog=$(sed -n "/## \[$version\]/,/## \[/p" CHANGELOG.md | sed '$d')
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$changelog" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        body: ${{ steps.changelog.outputs.changelog }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
  documentation:
    name: Deploy Documentation
    runs-on: macos-15
    needs: [test, release]
    
    steps:
    - name: Checkout
      uses: actions/checkout@v6
      
    - name: Install Tuist
      run: brew install tuist
      
    - name: Install Dependencies
      run: tuist install
      
    - name: Generate Project
      run: tuist generate
      
    - name: Build Documentation
      run: |
        xcodebuild docbuild \
          -scheme AsyncFlow \
          -destination 'generic/platform=iOS' \
          -derivedDataPath DerivedData
          
        $(xcrun --find docc) process-archive \
          transform-for-static-hosting \
          DerivedData/Build/Products/Debug-iphoneos/AsyncFlow.doccarchive \
          --output-path docs \
          --hosting-base-path AsyncFlow
          
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./docs
